##
## issue 13
##

- name: install basics packages
  hosts: r42_vuln_box_group
  become: true
  roles:
    - software.install.warmup.basic_packages

  #
  # variables defined in _main.yml
  #
  # vars:
  #   INSTALL_PACKAGES_BASICS: "YES"
  #   INSTALL_PACKAGES_FIREWALLS: "YES"
  #   #
  #   INSTALL_PACKAGES_DOCKER: "NO"
  #   INSTALL_PACKAGES_DOCKER_COMPOSE: "NO"
  #   #
  #   INSTALL_PACKAGES_UTILS_JSON: "NO"
  #   INSTALL_PACKAGES_UTILS_NETWORK: "YES"

  #   INSTALL_PACKAGES_NTP_AND_UPDATE_TIME: "YES"
  #
  #   SPECIFIC_PACKAGES_CLEANING: "NO"

# #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ####

- name: install dot files
  hosts: r42_vuln_box_group
  become: true
  roles:
    - software.install.warmup.dot_files

  vars:
    #
    # variables defined in _main.yml
    #
    # OPERATOR_USER: alice
    # INSTALL_VIM_DOTFILES: "YES"
    # INSTALL_ZSH_DOTFILES: "YES"

- name: configure firewall - all
  become: true
  hosts: r42_vuln_box_group
  roles:
    - software.configure.firewalls

  vars:
    #
    # variables defined in _main.yml
    #

    firewall_rules:
      - ip: "all"
        port: 22
        protocol: "tcp"

#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ####

- hosts: r42.admin-wazuh
  gather_facts: false
  vars_files:
    - "../../secrets/px-testing.cr42_tailscale.yml"

  vars:
    tailscale_hostnames:
      - "vuln-box-00"
      - "vuln-box-01"
      - "vuln-box-02"
      - "vuln-box-03"
      - "vuln-box-04"

    INSTALL_TAILSCALE: "YES" # variables defined in main

    requested_tasks:
      - delete/tailscale_client.yml
  #
  tasks:
    #
    #
    - name: TASK DYNAMIC INCLUDE FROM ansible.utils
      include_role:
        name: ansible.utils
      loop: "{{ tailscale_hostnames }}"
      loop_control:
        loop_var: tailscale_hostname
      when: INSTALL_TAILSCALE == "YES"

#### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### #### ####

##
## issue 11
##

- hosts: r42_vuln_box_group
  become: true
  vars_files:
    - "../../secrets/px-testing.cr42_tailscale.yml"
  vars:
    #
    # variables defined in vault
    #
    tailscale_authkey: "{{ vault_tailscale_authkey }}"
    INSTALL_TAILSCALE: "YES" # variables defined in main

  tasks:
    - block:
        - include_role:
            name: software.install.tailscale
        - include_role:
            name: software.configure.tailscale_disable_nftables

      when: INSTALL_TAILSCALE == "YES"
